version: 2.1

jobs:
  terraform-apply:
    docker:
      - image: circleci/python:3.8  # Choose an image with curl and jq
    steps:
      - checkout

      # Upload Configuration Step
      - run:
          name: Upload Configuration
          command: |
            curl --header "Authorization: Bearer $TF_API_TOKEN" \
                 --header "Content-Type: application/vnd.api+json" \
                 --request POST \
                 --data '{
                   "data": {
                     "type": "configuration-versions",
                     "relationships": {
                       "workspace": {
                         "data": {
                           "type": "workspaces",
                           "id": "$WORKSPACE_ID"
                         }
                       }
                     }
                   }
                 }' \
                 https://app.terraform.io/api/v2/configuration-versions

      - run:
          name: Trigger Apply Run
          command: |
            echo "Starting Terraform apply run..."
            curl --header "Authorization: Bearer $TF_API_TOKEN" \
                 --header "Content-Type: application/vnd.api+json" \
                 --request POST \
                 --data '{
                   "data": {
                     "type": "runs",
                     "relationships": {
                       "workspace": {
                         "data": {
                           "type": "workspaces",
                           "id": "$WORKSPACE_ID"
                         }
                       }
                     }
                   }
                 }' \
                 https://app.terraform.io/api/v2/runs

  terraform-destroy:
    docker:
      - image: circleci/python:3.8
    steps:
      - checkout

      # Upload Configuration Step (optional, if needed before destroy)
      - run:
          name: Upload Configuration
          command: |
            curl --header "Authorization: Bearer $TF_API_TOKEN" \
                 --header "Content-Type: application/vnd.api+json" \
                 --request POST \
                 --data '{
                   "data": {
                     "type": "configuration-versions",
                     "relationships": {
                       "workspace": {
                         "data": {
                           "type": "workspaces",
                           "id": "$WORKSPACE_ID"
                         }
                       }
                     }
                   }
                 }' \
                 https://app.terraform.io/api/v2/configuration-versions

      - run:
          name: Trigger Destroy Run
          command: |
            echo "Starting Terraform destroy run..."
            curl --header "Authorization: Bearer $TF_API_TOKEN" \
                 --header "Content-Type: application/vnd.api+json" \
                 --request POST \
                 --data '{
                   "data": {
                     "type": "runs",
                     "attributes": {
                       "is-destroy": true
                     },
                     "relationships": {
                       "workspace": {
                         "data": {
                           "type": "workspaces",
                           "id": "$WORKSPACE_ID"
                         }
                       }
                     }
                   }
                 }' \
                 https://app.terraform.io/api/v2/runs

workflows:
  version: 2
  scheduled-apply:
    triggers:
      - schedule:
          cron: "00 1 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - terraform-apply

  scheduled-destroy:
    triggers:
      - schedule:
          cron: "15 1 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - terraform-destroy
